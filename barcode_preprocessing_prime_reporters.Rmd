---
title: "Barcode preprocessing - Prime reporter library"
author: 
  - name: "Max Trauernicht"
    email: "m.trauernicht@nki.nl"
    affiliation: "Netherlands Cancer Institute - van Steensel lab"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---
---

### Aim
In this script barcode counts generated by transfection of prime TF reporter libraries will be processed. Quality checks will be carried out to ensure that the barcode counts accurately reflect the correct TF activities.

---

## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
      });

    });
</script>

```{css, echo = FALSE}
div.sourceCode {
  overflow-x: hidden;
}
```

### Libraries 

```{r setup, out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(plotly)
library(ggpubr)
library(plyr)
library(data.table)
library(ggbeeswarm)
library(viridis)
library(GGally)
library(pheatmap)
```


### Functions

```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
# Custom functions
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y, "pairwise.complete.obs")
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}

# Custom ggplot2 themes
theme_classic_lines <- function() {
  theme_pubr(border = T, legend = "top") +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
    
}

theme_classic_lines_45 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 45) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T,legend = "top", x.text.angle = 90) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_set(theme_classic_lines())

colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51")

ggplot_custom <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)
```

### Loading data

```{r data import, out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
# Load metadata file that contains all required information about the sequenced samples
metadata_df <- read_csv2("/DATA/usr/m.trauernicht/projects/prime_TF_reporters/data/mt20240826_metadata_all.csv")
metadata_df_pDNA_old <- read_csv2("/DATA/usr/m.trauernicht/projects/SuRE-TF/data/mt20240528_metadata_all.csv") %>%
  filter(file == "7027_73_pDNA_E2035_CCGCGGTT-TCTGTTGG_S73_barcode_counts.tsv") %>%
  mutate(pDNA = "pMT02")
metadata_df <- rbind.fill(metadata_df, metadata_df_pDNA_old) %>%
  mutate(library = "1+2") 

# Load in barcode counts
bc_files <- paste(metadata_df$path, metadata_df$file, sep = "")
bc_files <- lapply(bc_files, fread, header = FALSE)
## Name files by the combination of sample_id and pDNA
names(bc_files) <- paste(metadata_df$sample_id, metadata_df$pDNA, sep = "_")

# Import barcode annotation of both libraries
bc_annotation <- read_csv("/DATA/usr/m.trauernicht/projects/SuRE-TF/data/library_design/bc_annotation_combined.csv") %>%
  filter(library == "1+2")

# Import mini library barcodes
bc1_lib <- read_csv("/DATA/usr/m.trauernicht/projects/prime_TF_reporters/library_design/prime_reporter_library_single.csv") %>%
  mutate(downstream = gsub(".*CACGACGCTCTTCCGATCT", "", sequence)) %>%
  mutate(bc = gsub("(.*)CATCGTCGCATCCAAGAG", "\\1", downstream))

bc5_lib <- read_csv("/DATA/usr/m.trauernicht/projects/prime_TF_reporters/library_design/prime_reporter_library.csv") %>%
  mutate(downstream = gsub(".*CACGACGCTCTTCCGATCT", "", sequence)) %>%
  mutate(bc = gsub("(.*)CATCGTCGCATCCAAGAG", "\\1", downstream))

bc_annotation <- bc_annotation %>%
  mutate(in_bc1 = barcode %in% bc1_lib$bc,
         in_bc5 = barcode %in% bc5_lib$bc)
```


### Creating count data frames

```{r cluster_compare, out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
# Generate one long data frame from the list of data frames
bc_df <- bind_rows(bc_files, .id = "sample_id_pDNA") %>%
  dplyr::select(sample_id_pDNA, "barcode" = V1, "starcode_counts" = V2) %>%
  mutate(sample_id = gsub("(.*)_.*", "\\1", sample_id_pDNA),
         pDNA = gsub(".*_(.*)", "\\1", sample_id_pDNA)) %>%
  dplyr::select(-sample_id_pDNA)

# Library 1 has barcodes of length 12 while library 2 has barcodes of length 13
# For sequencing samples that have library 1 and 2 mixed I extracted barcodes of length >=12
# So, I will now filter out all barcodes with length >13, because those are not relevant
bc_df$nchar <- nchar(bc_df$barcode)
bc_df <- bc_df %>%
  filter(nchar <= 13)

# Add experiment annotation to the data
bc_df <- bc_df[!is.na(bc_df$sample_id),]
bc_df <- bc_df %>%
  left_join(metadata_df)

# Add barcode annotation (this will make the data table bigger - all barcodes that are not seen will have NA starcode counts)
bc_df <- merge(bc_df, bc_annotation, all = T, by = c("barcode", "library"))

# Assign 0 to NA counts and remove barcodes with wrong lengths
bc_df$starcode_counts[is.na(bc_df$starcode_counts)] <- 0
bc_df_remove <- bc_df %>%
  filter(nchar == 13 & bc_df$library == "1")
bc_df <- anti_join(bc_df, bc_df_remove)
bc_df_remove <- bc_df %>%
  filter(nchar == 12 & bc_df$library == "2")
bc_df <- anti_join(bc_df, bc_df_remove)

# Remove 0 count data (as they potentially introduce noise - we cannot discriminate low expression from too shallowly sequenced barcodes)
bc_df <- bc_df[bc_df$starcode_counts > 0,]

# Compute reads per million to estimate the relative counts in the respective sample
bc_df <- bc_df %>%
  mutate(rpm = ave(starcode_counts, sample_id, pDNA, FUN = function(x) (x) / sum(x) *1e6 ))

bc_df_filt <- bc_df[!is.na(bc_df$tf),]

bc_df_filt <- bc_df_filt %>%
  mutate(reporter_id = paste(tf, spacing, distance, promoter, background, sep = "_")) %>%
  mutate(reporter_id = gsub("bc-[0-9]{1,2}_", "", reporter_id))
```


## Identify barcodes that are present in the mini library and plot their distribution

Aim: Are all barcodes present in the library? If so, are they equally distributed?

```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
## Plot rpm distribution of barcodes per in_bc1 and in_bc5
ggplot(bc_df %>%
         filter(cell == "BC1"),
       aes(x = rpm)) +
  geom_histogram(bins = 100) +
  facet_wrap(~in_bc1) +
  theme_pubr() +
  ggtitle("Barcode counts of library with 1 BC per TF (True = matched barcode)")

ggplot(bc_df %>%
         filter(in_bc1, pDNA == "BC1"),
       aes(x = rpm)) +
  geom_histogram(bins = 100) +
  facet_wrap(~sample_id) +
  theme_pubr() +
  ggtitle("Same as before - per sample")

ggplot(bc_df %>%
         filter(cell == "BC5"),
       aes(x = rpm)) +
  geom_histogram(bins = 100) +
  facet_wrap(~in_bc5) +
  theme_pubr() +
  ggtitle("Barcode counts of library with 1 BC per TF (True = matched barcode)")

ggplot(bc_df %>%
         filter(in_bc5, pDNA == "BC5"),
       aes(x = log10(rpm))) +
  geom_histogram(bins = 100) +
  facet_wrap(~sample_id) +
  theme_pubr() +
  ggtitle("Same as before - per sample")

## Plot rpm distribution of barcodes per in_bc1 and in_bc5
ggplot(bc_df %>%
         filter(cell == "BC1", in_bc1),
       aes(x = 'BC1 library', y = rpm)) +
  geom_quasirandom() +
  theme_pubr() +
  ggtitle("Counts of all reporters that should be in BC1 library")

ggplot(bc_df %>%
         filter(cell == "BC5", in_bc5),
       aes(x = 'BC5 library', y = rpm)) +
  geom_quasirandom() +
  theme_pubr() +
  ggtitle("Counts of all reporters that should be in BC5 library")
```
Conclusion: All barcodes can be found in both libraries, and the majority of the reads comes from barcodes in the library. Also, the distribution of barcode counts shifts in the cDNA samples compared to the pDNA samples, which probably means that we are looking at real cDNA barcodes. Looks very good.

---

## Plot correlation between cDNA and pDNA barcode counts

Aim: Data quality check: do the counts come from amplifying pDNA or actual cDNA?
```{r read count 2, out.width= "80%", fig.align= "center",  warning= FALSE, message= FALSE}
# I want to show the following:
## 1: Read distribution of matched barcodes vs. unmatched barcode

### a: total read counts per sample
for (i in unique(bc_df_filt$pDNA[!is.na(bc_df_filt$pDNA)])) {
  bc_df_filt_i <- bc_df_filt[bc_df_filt$gcf == "gcf7866" & bc_df_filt$pDNA == i,]
  p <- plot_ly(bc_df_filt_i %>%
         mutate(sum_counts = ave(starcode_counts, sample, FUN = function(x) sum(x))) %>%
         dplyr::select(sample, sum_counts) %>%
         unique(), 
        x = ~sum_counts, y = ~sample, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = paste("Number of reads per barcode per sample", i),
         xaxis = list(title = "Expected number of reads per barcode per sample"),
         yaxis = list(title = "Sample"))
  print(p)
}


## 2: What is the correlation of the cDNA bc counts with the pDNA bc counts? 
pDNA_bc1 <- bc_df_filt[grep("BC1_r1_gcf7866", bc_df_filt$sample_id),] %>%
  filter(in_bc1) %>%
  dplyr::select(barcode, "pDNA" = sample_id, "pDNA_rpm" = rpm) %>%
  mutate(pDNA = "BC1")

pDNA_bc5 <- bc_df_filt[grep("BC5_r1_gcf7866", bc_df_filt$sample_id),] %>%
  filter(in_bc5) %>%
  dplyr::select(barcode, "pDNA" = sample_id, "pDNA_rpm" = rpm) %>%
  mutate(pDNA = "BC5")

pDNA_pMT02 <- bc_df_filt[grep("pDNA_r1_gcf7027", bc_df_filt$sample_id),] %>%
  dplyr::select(barcode, "pDNA" = sample_id, "pDNA_rpm" = rpm) %>%
  mutate(pDNA = "pMT02")

pDNA_all = rbind(pDNA_bc1, pDNA_bc5, pDNA_pMT02)


bc_df_filt <- merge(pDNA_all, bc_df_filt, all = T, by = c("barcode", "pDNA"))
bc_df_filt <- bc_df_filt[!is.na(bc_df_filt$sample_id),] %>% drop_na(pDNA_rpm)


ggplot(bc_df_filt %>%
         filter(pDNA == "pMT02"), aes(x = pDNA_rpm, y = rpm)) +
  geom_bin2d(bins = 50)+
  xlim(0,500) +
  ylim(0,2000)+
  scale_color_viridis() +
  facet_wrap(~sample_id)

ggplot(bc_df_filt %>%
         filter(pDNA == "BC1"), aes(x = pDNA_rpm, y = rpm)) +
  geom_point() +
  geom_abline() +
  xlim(0,35000) +
  ylim(0,35000) +
  facet_wrap(~sample_id)

ggplot(bc_df_filt %>%
         filter(pDNA == "BC5"), aes(x = pDNA_rpm, y = rpm)) +
  geom_point() +
  geom_abline() +
  xlim(0,10000) +
  ylim(0,10000) +
  facet_wrap(~sample_id)


# Generate correlation heatmaps
bc_df_i <- bc_df_filt %>%
  mutate(sample_id_pDNA = paste(sample_id, pDNA, sep = "_")) %>%
  dplyr::select(sample_id_pDNA, rpm, barcode)  %>%
  filter_all(any_vars(!is.na(.))) %>%
  unique() %>%
  spread(sample_id_pDNA, rpm) %>%
  filter_all(any_vars(!is.na(.))) %>%
  column_to_rownames("barcode")

x <- cor(bc_df_i, method = "pearson", use = "pairwise.complete.obs")

pheatmap(x, border = "black")




cor <- bc_df_filt %>%
  distinct(sample_id, pDNA) %>%
  mutate(cor = "")

for (i in unique(bc_df_filt$sample_id)) {
  for (j in unique(bc_df_filt$pDNA)) {
    if(nrow(bc_df_filt[bc_df_filt$sample_id == i & bc_df_filt$pDNA == j,]) >= 1) {
          cor$cor[cor$sample_id == i & cor$pDNA == j] <- stats::cor(bc_df_filt$rpm[bc_df_filt$sample_id == i & bc_df_filt$pDNA == j], 
                                                    bc_df_filt$pDNA_rpm[bc_df_filt$sample_id == i & bc_df_filt$pDNA == j], use = "pairwise.complete.obs")
    }
    }
}

cor <- cor %>%
  na.omit()

bc_df_filt <- merge(bc_df_filt, cor, by = c("sample_id", "pDNA"), all = T)
```
Conclusion: cDNA barcode counts don't correlate with pDNA counts - good! There are some differences between the formats (384, 96, 12-wells). 384-wells seems to have more pDNA bleedthrough, but it doesn't seem a very big issue (cDNA-pDNA Pearson correlation < 0.2).

---


### Normalization of barcode counts:  
Divide cDNA barcode counts through pDNA barcode counts to get activity

```{r normalization, out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
# Compute activity by dividing cDNA bc counts through pDNA bc counts
bc_df_filt$activity <- bc_df_filt$rpm / bc_df_filt$pDNA_rpm

# Remove rows that could not be computed due to too little pDNA counts
bc_df_cDNA <- bc_df_filt %>%
  drop_na(activity)
```


---

## Calculate correlation between barcodes

```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
## Combine replicates in 8 different columns
bc_df_rep <- bc_df_cDNA %>% 
  filter(pDNA == "BC5", in_bc5, sample_id != "BC5_r1_gcf7866") %>%
  dplyr::select(barcode_number, activity, sample_id, pDNA, reporter_id, neg_ctrls, library) %>%
  mutate(activity = log2(activity)) %>%
  spread(barcode_number, activity)
names(bc_df_rep) <- gsub("([1-9]{1})", "Barcode \\1", names(bc_df_rep))


ggscatter(bc_df_rep, x = "Barcode 1", y = "Barcode 2",
                 add = "reg.line",
                 color = "neg_ctrls",
                 size = 0.5,
                 add.params = list(color = "blue", fill = "lightgray"), 
                 title = paste("rep1 vs rep2 - library:", i),
                 conf.int = TRUE, ylab = "rep2", xlab = "rep1") + 
    stat_cor(method = "pearson", label.x = -3, label.y = -3) + 
    geom_abline(linetype = "dashed") +
    facet_wrap(~sample_id)


# Correlation matrix plot
n <- sample(1:nrow(bc_df_rep), 1000)
boundaries <- seq(from = 0.8, by = 0.05, length.out = 4)
plt <- ggpairs(bc_df_rep %>% dplyr::select('Barcode 1', 'Barcode 2', 'Barcode 3', 'Barcode 4', 'Barcode 5'),
               upper = list(continuous = corColor),
               lower = list(continuous = function(data, mapping, ...) {
                   ggally_points(data = data[n, ], mapping = mapping, alpha = 0.1, size = 0.5) +
                   geom_abline(slope = 1, lty = "dashed", col = "red") +
                   theme_pubr(border = T)}),
               diag = list(continuous = function(data, mapping, ...) {
                   ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red") +
                   theme_pubr(border = T)})) +
  ggtitle("Correlation Between Technial Replicates") +
  xlab("Reporter activity") +
  ylab("Reporter activity")

print(plt)
```
Conclusion: The five barcodes correlate very highly - we can just take the mean.

---


### Calculate mean activity

```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
## Calculate mean per condition and library
bc_df_cDNA_filt <- bc_df_cDNA %>%
  filter((pDNA == "BC5" & in_bc5) | (pDNA == "BC1" & in_bc1) | pDNA == "pMT02")

# Normalize by negative controls
bc_df_cDNA_neg <- bc_df_cDNA_filt %>%
  filter(tf %in% c("RANDOM1", "RANDOM2", "RANDOM3")) %>%
  distinct(reporter_id, sample_id, pDNA, activity, promoter) %>%
  mutate(background_activity = ave(activity, sample_id, pDNA, promoter, FUN = function(x) mean(x, na.rm = T))) %>%
  distinct(background_activity, sample_id, pDNA, promoter)

bc_df_cDNA_filt <- bc_df_cDNA_filt %>%
  left_join(bc_df_cDNA_neg) %>%
  mutate(activity_minP = activity / background_activity) %>%
  mutate(activity_minP_mean = ave(activity_minP, sample_id, pDNA, reporter_id, FUN = function (x) mean(x, na.rm = T))) %>%
  mutate(reporter_activity_minP = ave(activity_minP, condition, pDNA, format, reporter_id, FUN = function (x) mean(x, na.rm = T)))
```

---

## Correlate biological replicates
```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
bc_df_cDNA_filt_cor <- bc_df_cDNA_filt %>%
  distinct(reporter_id, activity_minP_mean, replicate, condition, pDNA, format) %>%
  mutate(activity_minP_mean = log2(activity_minP_mean)) %>%
  spread(replicate, activity_minP_mean)

ggplot(bc_df_cDNA_filt_cor %>%
         drop_na(format),
       aes(x = `r1`, y = `r2`)) +
  geom_point() +
  theme_pubr() +
  facet_grid(format~pDNA)
```
Conclusion: The biological replicates correlate very highly - we can just take the mean.

## Plot correlation between activities of the two different libraries and the three tested formats

Aim: Is the TF reporter libray with 1 barcode as good as the one with 5 barcodes? And how does the size of the wells impact the activities?
```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
tf_activites_format <- bc_df_cDNA_filt %>%
  distinct(reporter_activity_minP, reporter_id, condition, pDNA, format) %>%
  filter(!is.na(condition))

ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", pDNA == "BC5") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, format) %>%
         spread(format, reporter_activity_minP),
       aes(x = `12W`, y = `96W`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("5-Barcode library")

ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", pDNA == "BC5") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, format) %>%
         spread(format, reporter_activity_minP),
       aes(x = `12W`, y = `384W`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("5-Barcode library")

ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", pDNA == "pMT02") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, format) %>%
         spread(format, reporter_activity_minP),
       aes(x = `12W`, y = `96W`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("pMT02")


ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", format == "12W") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, pDNA) %>%
         spread(pDNA, reporter_activity_minP),
       aes(x = `BC1`, y = `BC5`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("12W")

ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", format == "96W") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, pDNA) %>%
         spread(pDNA, reporter_activity_minP),
       aes(x = `BC1`, y = `BC5`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("96W")

ggplot(tf_activites_format %>%
         filter(condition == "U2OS_DMSO", format == "384W") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, pDNA) %>%
         spread(pDNA, reporter_activity_minP),
       aes(x = `BC1`, y = `BC5`)) +
  geom_point() +
  theme_pubr() +
  geom_abline() +
  ggtitle("384W")
```
Conclusion: The two libraries give almost exactly the same activities -> we can even use the library with one barcode. The 384W format seems to be a bit worse than the 96W and 12W. But: good news - we can use the 96W format as it gives exactly the same data as when using 12W.

---

## Plot VDR activities in all libraries
Aim: Do we see VDR upregulation with all libraries?
```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
ggplot(bc_df_cDNA_filt %>%
         filter(reporter_id == "VDR::RXRA_10bp_21bp_mCMV_2", !is.na(condition), condition != "pDNA") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, pDNA, format, condition),
       aes(x = condition, y = reporter_activity_minP)) +
  geom_bar(stat = "identity") +
  theme_pubr(x.text.angle = 90) +
  facet_wrap(~pDNA)
```
Conclusion: In all libraries there is a clear VDR upregulation (~16-fold, which is less than before). 

---

## Compare activity from previously used library (pMT02) to new libraries
Aim: Show that the libraries recapitulate the previously measured activities with pMT02/09 well.
```{r out.width= "80%", fig.align= "center",  warning= FALSE, message=FALSE}
cDNA_df <- read.csv("/DATA/usr/m.trauernicht/projects/SuRE-TF/data/gcf7124_stimulations/results/mt20240528_reporter_activity_filt_combined.csv", header = T) %>%
  filter(condition %in% c("U2OS", "U2OS_Calcitriol")) %>%
  mutate(condition = ifelse(condition == "U2OS", "U2OS_DMSO", "U2OS_Calcitriol")) %>%
  distinct(reporter_id, condition, reporter_activity_minP) %>%
  mutate(pDNA = "pMT02_prev", format = "12W")

tf_activites_format_comb <- rbind(tf_activites_format, cDNA_df)

ggplot(tf_activites_format_comb %>%
         filter(condition == "U2OS_Calcitriol", format == "12W") %>%
         mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
         distinct(reporter_activity_minP, reporter_id, pDNA) %>%
         spread(pDNA, reporter_activity_minP),
       aes(x = `BC5`, y = `pMT02_prev`)) +
  geom_point() +
  theme_pubr() +
  geom_abline()


cor_tf_activities <- tf_activites_format_comb %>%
  filter(condition == "U2OS_Calcitriol", format == "12W") %>%
  mutate(reporter_activity_minP = log2(reporter_activity_minP)) %>%
  distinct(reporter_activity_minP, reporter_id, pDNA) %>%
  spread(pDNA, reporter_activity_minP) %>%
  na.omit()

cor(cor_tf_activities$BC5, cor_tf_activities$pMT02_prev)
```
Conclusion: Activities between new and old library seem to correlate very well (R ~ 0.9).
